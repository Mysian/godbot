"use strict";

const {
  SlashCommandBuilder,
  EmbedBuilder,
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle,
  ModalBuilder,
  TextInputBuilder,
  TextInputStyle,
} = require("discord.js");
const fs = require("fs");
const path = require("path");
const lockfile = require("proper-lockfile");
const crypto = require("crypto");
const _nodeFetch = async (...args) => {
  const { default: f } = await import('node-fetch');
  return f(...args);
};
const fetchSafe = (...args) => (global.fetch ? global.fetch(...args) : _nodeFetch(...args));

/* =========================
 * Í≥µÌÜµ ÏÑ§Ï†ï
 * ========================= */
const DATA_DIR = path.join(__dirname, "../data");
if (!fs.existsSync(DATA_DIR)) fs.mkdirSync(DATA_DIR, { recursive: true });
const MEMO_DIR = path.join(DATA_DIR, "memos");
if (!fs.existsSync(MEMO_DIR)) fs.mkdirSync(MEMO_DIR, { recursive: true });

const CUSTOM_PREFIX = "util:";     // Í≥µÌÜµ prefix
const CALC_PREFIX   = "calc:";     // Í≥ÑÏÇ∞Í∏∞
const MEMO_PREFIX   = "memo:";     // Î©îÎ™®Ïû•
const LOTTO_PREFIX  = "lotto:";    // Î≥µÍ∂å
const CONCH_PREFIX  = "conch:";    // ÏÜåÎùºÍ≥†Îèô
const IMG_PREFIX    = "img:";      // Ïù¥ÎØ∏ÏßÄ Í≤ÄÏÉâ

// Î©îÎ™® ÌéòÏù¥Ïßï
const MEMO_PAGE_SIZE = 10;

// Í≥ÑÏÇ∞Í∏∞ ÏÑ∏ÏÖò (Î©îÎ™®Î¶¨Îäî ÏùºÏãúÏ†ÅÏù¥Îùº Ï∂©Î∂Ñ)
const calcSessions = new Map(); // userId -> { a, b, op, input, last, updatedAt, hist, showHist }

/* =========================
 * Ïù¥ÎØ∏ÏßÄ Í≤ÄÏÉâ ÏÑ∏ÏÖò
 * ========================= */
const imageSessions = new Map(); // sessionId -> { q, lang, list, idx, shared, ownerId, createdAt }
const IMG_SESSION_TTL_MS = 15 * 60 * 1000; // 15Î∂Ñ

// Ïù¥ÎØ∏ÏßÄ Ï†úÍ≥µÏûê ÌÇ§ (ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í±¥ÎÑàÎúÄ)
const IMG_CFG = {
  bingKey: process.env.BING_KEY || process.env.BING_IMAGE_KEY,
  bingEndpoint: process.env.BING_IMAGE_ENDPOINT || "https://api.bing.microsoft.com/v7.0/images/search",
  googleKey: process.env.GOOGLE_API_KEY,
  googleCseId: process.env.GOOGLE_CSE_ID,
  naverId: process.env.NAVER_CLIENT_ID,
  naverSecret: process.env.NAVER_CLIENT_SECRET,
};

/* =========================
 * Ïú†Ìã∏ Ìï®Ïàò
 * ========================= */
function formatKST(ts) {
  if (ts == null) return "";
  const d = new Date(ts);
  return d.toLocaleString("ko-KR", { timeZone: "Asia/Seoul", hour12: false });
}
function clampLen(str, max) {
  if (!str) return "";
  return str.length <= max ? str : (str.slice(0, max - 1) + "‚Ä¶");
}
function nowKST() {
  const now = new Date();
  return now;
}
function seedFromString(s) {
  const h = crypto.createHash("sha256").update(s).digest();
  return h.readUInt32LE(0);
}
function mulberry32(seed) {
  let t = seed >>> 0;
  return function () {
    t += 0x6D2B79F5;
    let x = t;
    x = Math.imul(x ^ (x >>> 15), x | 1);
    x ^= x + Math.imul(x ^ (x >>> 7), x | 61);
    return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
  };
}
function weekKeyKST(d = nowKST()) {
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const onejan = new Date(dt.getFullYear(), 0, 1);
  const dayms = 24 * 60 * 60 * 1000;
  const week = Math.ceil((((dt - onejan) / dayms) + onejan.getDay() + 1) / 7);
  return `${dt.getFullYear()}-${String(week).padStart(2, "0")}`;
}
function pickRandom(arr, seedStr = String(Date.now())) {
  if (!Array.isArray(arr) || !arr.length) return null;
  const r = mulberry32(seedFromString(seedStr))();
  const idx = Math.floor(r * arr.length);
  return { item: arr[idx], idx };
}
function hasHangul(s) {
  return /[Í∞Ä-Ìû£]/.test(s || "");
}
function detectLang(q) {
  return hasHangul(q) ? "ko-KR" : "en-US";
}
function pruneOldImageSessions() {
  const now = Date.now();
  for (const [k, v] of imageSessions.entries()) {
    if ((now - (v.createdAt || 0)) > IMG_SESSION_TTL_MS) imageSessions.delete(k);
  }
}

/* =========================
 * Î©îÎ™® ÌååÏùº IO (proper-lockfile)
 * ========================= */
function memoFile(userId) {
  return path.join(MEMO_DIR, `${userId}.json`);
}
function ensureMemoFile(userId) {
  const f = memoFile(userId);
  if (!fs.existsSync(f)) fs.writeFileSync(f, "[]", "utf8");
  return f;
}
async function readMemos(userId) {
  const f = ensureMemoFile(userId);
  const release = await lockfile.lock(f, { retries: { retries: 5, factor: 1.5, minTimeout: 50 } });
  try {
    const raw = fs.readFileSync(f, "utf8").trim();
    let arr = [];
    if (raw) arr = JSON.parse(raw);
    const now = Date.now();
    let changed = false;
    arr = arr.filter(m => {
      if (!m.expiresAt) return true;
      const keep = now <= m.expiresAt;
      if (!keep) changed = true;
      return keep;
    });
    if (changed) fs.writeFileSync(f, JSON.stringify(arr, null, 2), "utf8");
    return arr;
  } finally {
    await release();
  }
}
async function writeMemos(userId, list) {
  const f = ensureMemoFile(userId);
  const release = await lockfile.lock(f, { retries: { retries: 5, factor: 1.5, minTimeout: 50 } });
  try {
    fs.writeFileSync(f, JSON.stringify(list, null, 2), "utf8");
  } finally {
    await release();
  }
}

/* =========================
 * Í≥ÑÏÇ∞Í∏∞
 * ========================= */
function renderCalcEmbed(userId) {
  const st = calcSessions.get(userId) || { a: null, b: null, op: null, input: "", last: null, updatedAt: Date.now(), hist: [], showHist: false };
  const { a, op, input, last } = st;
  const display = input || (a !== null ? String(a) : "0");
  const expr = `${a !== null ? a : ""} ${op || ""} ${input ? input : ""}`.trim() || (last !== null ? `ans: ${last}` : "ready");
  const eb = new EmbedBuilder()
    .setTitle("üßÆ Í≥ÑÏÇ∞Í∏∞")
    .setDescription("Í∞ÑÎã® Í≥ÑÏÇ∞ ÌòÑÌô©")
    .addFields(
      { name: "ÌëúÏãú", value: "```\n" + display + "\n```", inline: false },
      { name: "Ïãù", value: expr || "-", inline: false },
    )
    .setColor(0x5865F2);

  if (st.showHist && Array.isArray(st.hist) && st.hist.length) {
    const lines = st.hist.slice(0, 8).join("\n");
    eb.addFields({ name: "ÏµúÍ∑º Í≥ÑÏÇ∞ (ÏµúÎåÄ 10Í∞ú)", value: "```\n" + lines + "\n```", inline: false });
  }
  return eb;
}
function renderCalcButtons(st) {
  const row1 = new ActionRowBuilder().addComponents(
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|7").setLabel("7").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|8").setLabel("8").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|9").setLabel("9").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "op|muldiv").setLabel("x/√∑").setStyle(ButtonStyle.Primary),
  );
  const row2 = new ActionRowBuilder().addComponents(
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|4").setLabel("4").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|5").setLabel("5").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|6").setLabel("6").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "op|-").setLabel("-").setStyle(ButtonStyle.Primary),
  );
  const row3 = new ActionRowBuilder().addComponents(
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|1").setLabel("1").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|2").setLabel("2").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|3").setLabel("3").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "op|+").setLabel("+").setStyle(ButtonStyle.Primary),
  );
  const row4 = new ActionRowBuilder().addComponents(
    new ButtonBuilder().setCustomId(CALC_PREFIX + "neg").setLabel("+/-").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "key|0").setLabel("0").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "dot").setLabel(".").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "eq").setLabel("=").setStyle(ButtonStyle.Success),
  );
  const row5 = new ActionRowBuilder().addComponents(
    new ButtonBuilder().setCustomId(CALC_PREFIX + "clear").setLabel("CLEAR").setStyle(ButtonStyle.Danger),
    new ButtonBuilder().setCustomId(CALC_PREFIX + "history").setLabel("HISTORY").setStyle(ButtonStyle.Secondary),
  );
  return [row1, row2, row3, row4, row5];
}
function pushDigit(st, d) {
  if (!st.input) st.input = d;
  else st.input += d;
}
function pushDot(st) {
  if (!st.input) st.input = "0.";
  else if (!st.input.includes(".")) st.input += ".";
}
function toggleSign(st) {
  if (!st.input) st.input = "0";
  if (st.input.startsWith("-")) st.input = st.input.slice(1);
  else st.input = "-" + st.input;
}
function applyOp(st, op) {
  if (op === "muldiv") {
    if (st.op === "*" ) st.op = "/";
    else if (st.op === "/") st.op = "*";
    else st.op = "*";
    if (st.a === null && st.input) {
      st.a = Number(st.input);
      st.input = "";
    }
    return;
  }
  if (st.a === null && st.input) {
    st.a = Number(st.input);
    st.input = "";
  }
  st.op = op;
}
function pushHistory(st, a, op, b, res) {
  try {
    const line = `${a} ${op} ${b} = ${Number.isFinite(res) ? res : String(res)}`;
    st.hist = Array.isArray(st.hist) ? st.hist : [];
    st.hist.unshift(line);
    if (st.hist.length > 10) st.hist.length = 10;
  } catch { /* noop */ }
}
function calcEqual(st) {
  const a = st.a;
  const b = st.input ? Number(st.input) : null;
  if (a === null || st.op === null || b === null) return;
  let res = 0;
  if (st.op === "+") res = a + b;
  else if (st.op === "-") res = a - b;
  else if (st.op === "*") res = a * b;
  else if (st.op === "/") res = b === 0 ? NaN : a / b;

  st.last = res;
  pushHistory(st, a, st.op, b, res);
  st.a = res;
  st.input = "";
  st.op = null;
  st.updatedAt = Date.now();
}

/* =========================
 * Î©îÎ™®Ïû•
 * ========================= */
function renderMemoListEmbed(userId, list, page, query) {
  const total = list.length;
  const maxPage = Math.max(0, Math.ceil(total / MEMO_PAGE_SIZE) - 1);
  const p = Math.min(Math.max(0, page), maxPage);
  const start = p * MEMO_PAGE_SIZE;
  const slice = list.slice(start, start + MEMO_PAGE_SIZE);

  const lines = slice.map((m, i) => {
    const idx = start + i + 1;
    const title = clampLen(m.title || "(Ï†úÎ™© ÏóÜÏùå)", 40);
    const d = formatKST(m.createdAt);
    return `**${idx}.** ${title} „Éª ${d}`;
  });
  const desc = (query ? `üîé Í≤ÄÏÉâÏñ¥: **${query}**\n` : "") + (lines.length ? lines.join("\n") : "Î©îÎ™®Í∞Ä ÏóÜÏäµÎãàÎã§.");

  return new EmbedBuilder()
    .setTitle("üìí Î©îÎ™®Ïû•")
    .setDescription(desc)
    .setFooter({ text: `Ï¥ù ${total}Í∞ú „Éª ${p + 1}/${maxPage + 1}` })
    .setColor(0x2ECC71);
}
function renderMemoListButtons(list, page, query) {
  const total = list.length;
  const maxPage = Math.max(0, Math.ceil(total / MEMO_PAGE_SIZE) - 1);
  const p = Math.min(Math.max(0, page), maxPage);
  const start = p * MEMO_PAGE_SIZE;
  const slice = list.slice(start, start + MEMO_PAGE_SIZE);

  const rowA = new ActionRowBuilder();
  const rowB = new ActionRowBuilder();

  slice.forEach((m, i) => {
    const idx = start + i + 1;
    const btn = new ButtonBuilder()
      .setCustomId(MEMO_PREFIX + `open|${m.id}|${p}`)
      .setLabel(String(idx))
      .setStyle(ButtonStyle.Secondary);
    if (i < 5) rowA.addComponents(btn); else rowB.addComponents(btn);
  });

  const rowNav = new ActionRowBuilder().addComponents(
    new ButtonBuilder().setCustomId(MEMO_PREFIX + `prev|${p}`).setLabel("‚óÄ Ïù¥Ï†Ñ").setStyle(ButtonStyle.Primary).setDisabled(p <= 0),
    new ButtonBuilder().setCustomId(MEMO_PREFIX + "page").setLabel(`${p + 1}/${maxPage + 1}`).setStyle(ButtonStyle.Secondary).setDisabled(true),
    new ButtonBuilder().setCustomId(MEMO_PREFIX + `next|${p}`).setLabel("Îã§Ïùå ‚ñ∂").setStyle(ButtonStyle.Primary).setDisabled(p >= maxPage),
    new ButtonBuilder().setCustomId(MEMO_PREFIX + `search|${query ? encodeURIComponent(query) : ""}|${p}`).setEmoji("üîé").setLabel("Í≤ÄÏÉâ").setStyle(ButtonStyle.Secondary),
    new ButtonBuilder().setCustomId(MEMO_PREFIX + `add|${p}`).setEmoji("‚ûï").setLabel("ÏÉà Î©îÎ™®").setStyle(ButtonStyle.Success),
  );

  const rows = [];
  if (rowA.components.length) rows.push(rowA);
  if (rowB.components.length) rows.push(rowB);
  rows.push(rowNav);
  return rows;
}
function renderMemoDetailEmbed(m) {
  const exp = m.expiresAt ? formatKST(m.expiresAt) : "Î¨¥Í∏∞Ìïú";
  const body = (m.body && m.body.trim().length) ? m.body : "(ÎÇ¥Ïö© ÏóÜÏùå)";
  const bodyBox = "```\n" + body + "\n```";

  return new EmbedBuilder()
    .setTitle(`üóí ${m.title || "(Ï†úÎ™© ÏóÜÏùå)"}`)
    .setDescription(bodyBox)
    .addFields({ name: "Î≥¥Í¥Ä Í∏∞Ìïú", value: exp, inline: false })
    .setFooter({ text: `ÏûëÏÑ±: ${formatKST(m.createdAt)} „Éª ID: ${m.id}` })
    .setColor(0x3498DB);
}
function renderMemoDetailButtons(page) {
  return [
    new ActionRowBuilder().addComponents(
      new ButtonBuilder().setCustomId(MEMO_PREFIX + `back|${page}`).setLabel("Î™©Î°ùÏúºÎ°ú").setStyle(ButtonStyle.Secondary),
      new ButtonBuilder().setCustomId(MEMO_PREFIX + `edit|${page}`).setLabel("ÏàòÏ†ï").setStyle(ButtonStyle.Primary),
      new ButtonBuilder().setCustomId(MEMO_PREFIX + `del`).setEmoji("üóë").setLabel("ÏÇ≠Ï†ú").setStyle(ButtonStyle.Danger),
    ),
  ];
}

/* =========================
 * Î≥µÍ∂åÎ≤àÌò∏
 * ========================= */
function bestBuyDay(userId) {
  const key = weekKeyKST(nowKST());
  const seed = seedFromString(`${userId}:${key}`);
  const rnd = mulberry32(seed)();
  const idx = Math.floor(rnd * 6);
  const days = ["ÏõîÏöîÏùº", "ÌôîÏöîÏùº", "ÏàòÏöîÏùº", "Î™©ÏöîÏùº", "Í∏àÏöîÏùº", "ÌÜ†ÏöîÏùº"];
  return days[idx];
}
function genLottoLines(n = 5, seedStr = String(Date.now())) {
  const rng = mulberry32(seedFromString(seedStr));
  const lines = [];
  for (let i = 0; i < n; i++) {
    const set = new Set();
    while (set.size < 6) {
      const v = 1 + Math.floor(rng() * 45);
      set.add(v);
    }
    const arr = [...set].sort((a, b) => a - b);
    lines.push(arr);
  }
  return lines;
}
function renderLottoEmbed(userId, lines) {
  const day = bestBuyDay(userId);
  const desc = lines.map((arr, i) => `**${i + 1}**) ${arr.join(", ")}`).join("\n");
  return new EmbedBuilder()
    .setTitle("üéü Î≥µÍ∂å Î≤àÌò∏ Ï∂îÏ≤®")
    .setDescription(`Ïù¥Î≤à Ï£º Ï∂îÏ≤ú ÏöîÏùº: **${day}**\n\n${desc}`)
    .setColor(0xF1C40F);
}
function renderLottoButtons() {
  return [
    new ActionRowBuilder().addComponents(
      new ButtonBuilder().setCustomId(LOTTO_PREFIX + "regen").setLabel("Îã§Ïãú ÎΩëÍ∏∞").setStyle(ButtonStyle.Success),
    ),
  ];
}

/* =========================
 * Ïù¥ÎØ∏ÏßÄ Í≤ÄÏÉâ
 * ========================= */
function sanitizeImageUrl(u) {
  if (!u) return null;
  // ÎîîÏä§ÏΩîÎìúÏóêÏÑú Ïûò Î≥¥Ïù¥Îäî ÌôïÏû•Ïûê ÏúÑÏ£º ÌïÑÌÑ∞(ÏóÑÍ≤© X)
  if (!/^https?:\/\//i.test(u)) return null;
  return u.replace(/^http:\/\//i, "https://");
}
async function searchBingImages(q, lang) {
  if (!IMG_CFG.bingKey) return [];
  const url = new URL(IMG_CFG.bingEndpoint);
  url.searchParams.set("q", q);
  url.searchParams.set("count", "50");
  url.searchParams.set("safeSearch", "Moderate");
  url.searchParams.set("mkt", lang || "ko-KR");
  url.searchParams.set("imageType", "Photo");
  const res = await fetchSafe(url, {
    headers: {
      "Ocp-Apim-Subscription-Key": IMG_CFG.bingKey,
      "Accept-Language": lang || "ko-KR",
      "User-Agent": "Mozilla/5.0",
    },
  });
  if (!res.ok) return [];
  const json = await res.json();
  const items = Array.isArray(json.value) ? json.value : [];
  const urls = items.map(v => sanitizeImageUrl(v.contentUrl || v.contentUrlHttps || v.thumbnailUrl)).filter(Boolean);
  return urls;
}

async function searchGoogleImages(q) {
  if (!IMG_CFG.googleKey || !IMG_CFG.googleCseId) return [];
  const url = new URL("https://www.googleapis.com/customsearch/v1");
  url.searchParams.set("key", IMG_CFG.googleKey);
  url.searchParams.set("cx", IMG_CFG.googleCseId);
  url.searchParams.set("q", q);
  url.searchParams.set("searchType", "image");
  url.searchParams.set("num", "10");
  const res = await fetchSafe(url, { headers: { "User-Agent": "Mozilla/5.0" } });
  if (!res.ok) return [];
  const json = await res.json();
  const items = Array.isArray(json.items) ? json.items : [];
  const urls = items.map(it => sanitizeImageUrl(it.link)).filter(Boolean);
  return urls;
}

async function searchNaverImages(q) {
  if (!IMG_CFG.naverId || !IMG_CFG.naverSecret) return [];
  const url = new URL("https://openapi.naver.com/v1/search/image.json");
  url.searchParams.set("query", q);
  url.searchParams.set("display", "30");
  url.searchParams.set("sort", "sim");
  const res = await fetchSafe(url, {
    headers: {
      "X-Naver-Client-Id": IMG_CFG.naverId,
      "X-Naver-Client-Secret": IMG_CFG.naverSecret,
      "User-Agent": "Mozilla/5.0",
    },
  });
  if (!res.ok) return [];
  const json = await res.json();
  const items = Array.isArray(json.items) ? json.items : [];
  const urls = items.map(it => sanitizeImageUrl(it.link)).filter(Boolean);
  return urls;
}
// ‚úÖ DuckDuckGo Ïù¥ÎØ∏ÏßÄ(Î¨¥ÌÇ§). ÏÑúÎ≤ÑÏóêÏÑú Í∞ÄÎÅî rate limit ÏûàÏúºÎÇò ÏÑ±Í≥µÎ•† ÎÜíÏùå
async function searchDuckDuckGoImages(q) {
  try {
    const url = new URL("https://duckduckgo.com/i.js");
    url.searchParams.set("q", q);
    url.searchParams.set("o", "json");
    url.searchParams.set("iax", "images");
    url.searchParams.set("ia", "images");
    const res = await fetchSafe(url);
    if (!res.ok) return [];
    const json = await res.json();
    const items = Array.isArray(json.results) ? json.results : [];
    const urls = items.map(it => sanitizeImageUrl(it.image || it.thumbnail)).filter(Boolean);
    return urls;
  } catch (e) {
    // console.warn("[DDG]", e);
    return [];
  }
}

// ‚úÖ Unsplash(Î¨¥ÌÇ§) ‚Äî Î¶¨Îã§Ïù¥Î†âÌä∏ÏßÄÎßå ÎîîÏä§ÏΩîÎìúÍ∞Ä Îî∞ÎùºÍ∞ê, Ï£ºÏ†ú Í¥ÄÎ†® ÎûúÎç§ 1Ïû•
function unsplashDirectUrl(q) {
  const qp = encodeURIComponent(q);
  return `https://source.unsplash.com/featured/1280x720/?${qp}`;
}
async function searchUnsplashNoKey(q) {
  return [unsplashDirectUrl(q)];
}

// ‚úÖ LoremFlickr(Î¨¥ÌÇ§) ‚Äî Ï∫êÏãú ÎùΩÏúºÎ°ú Îß§Î≤à Îã§Î•∏ ÎûúÎç§ 1Ïû•
function loremFlickrDirectUrl(q) {
  const tag = encodeURIComponent(q.replace(/\s+/g, ','));
  const lock = Math.floor(Math.random() * 1e9);
  return `https://loremflickr.com/1280/720/${tag}?lock=${lock}`;
}
async function searchLoremFlickrDirect(q) {
  return [loremFlickrDirectUrl(q)];
}


// ‚úÖ Wikimedia Commons(Î¨¥ÌÇ§) ‚Äî "ÌååÏùº" ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§(6)Îßå Í≤ÄÏÉâÌï¥ÏÑú Ïù¥ÎØ∏ÏßÄ Î≥¥Ïû•
async function searchWikimediaImages(q) {
  try {
    const url = new URL("https://commons.wikimedia.org/w/api.php");
    url.searchParams.set("action", "query");
    url.searchParams.set("generator", "search");
    url.searchParams.set("gsrsearch", q);
    url.searchParams.set("gsrlimit", "30");
    url.searchParams.set("gsrnamespace", "6"); // ÌååÏùº ÎÑ§ÏûÑÏä§ÌéòÏù¥Ïä§Îßå
    url.searchParams.set("prop", "imageinfo");
    url.searchParams.set("iiprop", "url");
    url.searchParams.set("iiurlwidth", "1600");
    url.searchParams.set("format", "json");

    const res = await fetchSafe(url);
    if (!res.ok) return [];
    const json = await res.json();
    const pages = json?.query?.pages || {};
    const urls = [];
    for (const k in pages) {
      const info = pages[k]?.imageinfo?.[0];
      const u = (info?.thumburl || info?.url) || null;
      const su = sanitizeImageUrl(u);
      if (su) urls.push(su);
    }
    return urls;
  } catch {
    return [];
  }
}


async function findImages(q, lang) {
  const seen = new Set();
  const out = [];
  async function addFrom(fn) {
    try {
      const arr = await fn();
      for (const u of arr) {
        const su = sanitizeImageUrl(u);
        if (su && !seen.has(su)) { seen.add(su); out.push(su); }
      }
    } catch { /* ignore */ }
  }

  // 0) Î¨¥ÌÇ§ ‚ÄòÏ¶âÏãú ÏÑ±Í≥µ‚Äô ÎùºÏù∏ ‚Äî Ïó¨Í∏∞ÏÑú ÏµúÏÜå 1Ïû•ÏùÄ Î≥¥Ïû•
  await addFrom(() => searchUnsplashNoKey(q));
  if (out.length < 1) await addFrom(() => searchLoremFlickrDirect(q));

  // 1) ÌÇ§ Í∏∞Î∞ò (ÏûàÏúºÎ©¥ Îã§ÏñëÏÑ± ‚Üë)
  if (out.length < 3) await addFrom(() => searchBingImages(q, lang));
  if (out.length < 3) await addFrom(() => searchGoogleImages(q));
  if (out.length < 3) await addFrom(() => searchNaverImages(q));

  // 2) Î¨¥ÌÇ§ API Ìè¥Î∞± (DDGÎäî Ï¢ÖÏ¢Ö ÎßâÌûàÏßÄÎßå ÏÑ±Í≥µÌï† Îïå ÎßéÏùå)
  if (out.length < 3) await addFrom(() => searchWikimediaImages(q));
  if (out.length < 3) await addFrom(() => searchDuckDuckGoImages(q));

  return out;
}

function renderImageEmbed(q, url, lang, shared = false) {
  const eb = new EmbedBuilder()
    .setTitle(`üñºÔ∏è Ïù¥ÎØ∏ÏßÄ: ${q}`)
    .setImage(url)
    .setColor(shared ? 0x00C853 : 0x00B7FF)
    .setFooter({ text: `ÎûúÎç§ Ïù¥ÎØ∏ÏßÄ ‚Ä¢ ÏïàÏ†ÑÍ≤ÄÏÉâ: Moderate ‚Ä¢ Ïñ∏Ïñ¥: ${lang}` });
  return eb;
}
function renderImageButtons(sessionId, shared) {
  return [
    new ActionRowBuilder().addComponents(
      new ButtonBuilder()
        .setCustomId(IMG_PREFIX + `share|${sessionId}`)
        .setLabel(shared ? "Í≥µÏú†Îê®" : "Ïù¥ÎØ∏ÏßÄ Í≥µÏú†")
        .setStyle(shared ? ButtonStyle.Success : ButtonStyle.Primary)
        .setDisabled(shared),
      new ButtonBuilder()
        .setCustomId(IMG_PREFIX + `more|${sessionId}`)
        .setLabel("Îã§Î•∏ Ïù¥ÎØ∏ÏßÄ")
        .setStyle(ButtonStyle.Secondary),
    ),
  ];
}

/* =========================
 * SlashCommand Ï†ïÏùò
 * ========================= */
module.exports = {
  data: new SlashCommandBuilder()
    .setName("Ïú†Ìã∏")
    .setDescription("Ïú†Ìã∏Î¶¨Ìã∞ ÎèÑÍµ¨ Î™®Ïùå")
    .addSubcommand(sc => sc.setName("Í≥ÑÏÇ∞Í∏∞").setDescription("Î≤ÑÌäº Í≥ÑÏÇ∞Í∏∞"))
    .addSubcommand(sc => sc.setName("Î©îÎ™®Ïû•").setDescription("Í∞úÏù∏ Î©îÎ™®/Í≤ÄÏÉâ/ÏàòÏ†ï/ÏÇ≠Ï†ú"))
    .addSubcommand(sc => sc.setName("Î≥µÍ∂åÎ≤àÌò∏").setDescription("1~45 Ï§ë 6Í∞ú, Ï¥ù 5Ï§Ñ"))
    .addSubcommand(sc => sc.setName("ÎßàÎ≤ïÏùòÏÜåÎùºÍ≥†Îèô").setDescription("Î¥áÏù¥ Í∑∏Îûò/ÏïÑÎãà ÎãµÎ≥Ä"))
    // ‚úÖ Ïã†Í∑ú: Ïù¥ÎØ∏ÏßÄ
    .addSubcommand(sc =>
      sc.setName("Ïù¥ÎØ∏ÏßÄ")
        .setDescription("ÏûÖÎ†•Ìïú ÎåÄÏÉÅÏùò ÎûúÎç§ Ïù¥ÎØ∏ÏßÄÎ•º Î≥¥Ïó¨Ï§çÎãàÎã§")
        .addStringOption(o =>
          o.setName("ÎåÄÏÉÅ")
            .setDescription("ÌïúÍ∏Ä/ÏòÅÏñ¥ ÌÇ§ÏõåÎìú")
            .setRequired(true)
        )
    ),

  // Slash Î™ÖÎ†π Ï≤òÎ¶¨
  async execute(interaction) {
    const sub = interaction.options.getSubcommand();
    const userId = interaction.user.id;

    if (sub === "Í≥ÑÏÇ∞Í∏∞") {
      if (!calcSessions.has(userId)) {
        calcSessions.set(userId, { a: null, b: null, op: null, input: "", last: null, updatedAt: Date.now(), hist: [], showHist: false });
      }
      const st = calcSessions.get(userId);
      const embed = renderCalcEmbed(userId);
      const rows = renderCalcButtons(st);
      return interaction.reply({ embeds: [embed], components: rows, ephemeral: true });
    }

    if (sub === "Î©îÎ™®Ïû•") {
      const list = await readMemos(userId);
      const page = 0;
      const embed = renderMemoListEmbed(userId, list, page, "");
      const rows = renderMemoListButtons(list, page, "");
      return interaction.reply({ embeds: [embed], components: rows, ephemeral: true });
    }

    if (sub === "Î≥µÍ∂åÎ≤àÌò∏") {
      const lines = genLottoLines(5, `${userId}:${Date.now()}`);
      const embed = renderLottoEmbed(userId, lines);
      const rows = renderLottoButtons();
      return interaction.reply({ embeds: [embed], components: rows, ephemeral: true });
    }

    if (sub === "ÎßàÎ≤ïÏùòÏÜåÎùºÍ≥†Îèô") {
      const embed = new EmbedBuilder()
        .setTitle("üêö ÎßàÎ≤ïÏùò ÏÜåÎùºÍ≥†Îèô")
        .setDescription("ÏïÑÎ¨¥ ÎßêÏù¥ÎÇò **ÏßàÎ¨∏**ÏùÑ Ìï¥Î¥ê!\n> **Î¥áÏù¥ ‚ÄòÍ∑∏Îûò‚Äô ÎòêÎäî ‚ÄòÏïÑÎãà‚Äô Ï§ë ÌïòÎÇòÎ°úÎßå** ÎåÄÎãµÌï¥Ï§ÑÍ≤å.\n\n**ÏïàÎÇ¥**: _Î¥áÏù¥ **Í∑∏Îûò/ÏïÑÎãà**Î°ú ÎãµÎ≥Ä Í∞ÄÎä•Ìïú ÏßàÎ¨∏ÏùÑ Ìï¥Ï£ºÏÑ∏Ïöî._")
        .setColor(0xA66BFF);
      const rows  = [
        new ActionRowBuilder().addComponents(
          new ButtonBuilder()
            .setCustomId(CONCH_PREFIX + "ask")
            .setLabel("ÏßàÎ¨∏ÌïòÍ∏∞")
            .setStyle(ButtonStyle.Primary)
        ),
      ];
      return interaction.reply({ embeds: [embed], components: rows, ephemeral: true });
    }

    // ‚úÖ Ïã†Í∑ú: Ïù¥ÎØ∏ÏßÄ
    if (sub === "Ïù¥ÎØ∏ÏßÄ") {
      pruneOldImageSessions();
      const qRaw = interaction.options.getString("ÎåÄÏÉÅ", true).trim();
      const q = qRaw.replace(/\s+/g, " ");
      if (!q.length) return interaction.reply({ content: "ÎåÄÏÉÅÏùÑ ÏûÖÎ†•Ìï¥Ï§ò.", ephemeral: true });

      const lang = detectLang(q);

      // Í≤ÄÏÉâ
      let urls = await findImages(q, lang);
      // Í∞ÑÎã®Ìïú Ï§ëÎ≥µ/ÌíàÏßà ÌïÑÌÑ∞
      urls = urls.filter(u => /\.(jpe?g|png|gif|webp|bmp|svg)(\?|#|$)/i.test(u) || true);
      if (!urls.length) {
        return interaction.reply({ content: "Ï£ÑÏÜ°Ìï©ÎãàÎã§, Í≤ÄÏÉâ Í≤∞Í≥ºÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.", ephemeral: true });
      }

      const { item: url, idx } = pickRandom(urls, `${q}:${Date.now()}:${interaction.user.id}`);
      const sessionId = crypto.randomBytes(8).toString("hex");
      imageSessions.set(sessionId, { q, lang, list: urls, idx, shared: false, ownerId: userId, createdAt: Date.now() });

      const embed = renderImageEmbed(q, url, lang, false);
      const rows = renderImageButtons(sessionId, false);
      return interaction.reply({ embeds: [embed], components: rows, ephemeral: true });
    }
  },

  // Î≤ÑÌäº/Î™®Îã¨ ÎùºÏö∞ÌåÖ (index.jsÏóêÏÑú ÏúÑÏûÑ Ìò∏Ï∂ú)
  async route(interaction) {
    const { customId, user } = interaction;

    /* ===== Í≥ÑÏÇ∞Í∏∞ ===== */
    if (customId.startsWith(CALC_PREFIX)) {
      const userId = user.id;
      const st = calcSessions.get(userId) || { a: null, b: null, op: null, input: "", last: null, updatedAt: Date.now(), hist: [], showHist: false };

      if (customId === CALC_PREFIX + "neg") toggleSign(st);
      else if (customId === CALC_PREFIX + "dot") pushDot(st);
      else if (customId === CALC_PREFIX + "eq") calcEqual(st);
      else if (customId.startsWith(CALC_PREFIX + "key|")) {
        const d = customId.split("|")[1];
        if (/^\d$/.test(d)) pushDigit(st, d);
      } else if (customId.startsWith(CALC_PREFIX + "op|")) {
        const op = customId.split("|")[1];
        if (op === "+" || op === "-") applyOp(st, op);
        else if (op === "muldiv") applyOp(st, "muldiv");
      }
      else if (customId === CALC_PREFIX + "clear") {
        st.a = null;
        st.b = null;
        st.op = null;
        st.input = "";
        st.last = null;
        st.updatedAt = Date.now();
      }
      else if (customId === CALC_PREFIX + "history") {
        st.showHist = !st.showHist;
        st.updatedAt = Date.now();
      }

      calcSessions.set(userId, st);
      const embed = renderCalcEmbed(userId);
      const rows = renderCalcButtons(st);
      return interaction.update({ embeds: [embed], components: rows });
    }

    /* ===== Î©îÎ™®Ïû•: Î≤ÑÌäº & Î™®Îã¨ ===== */
    if (customId.startsWith(MEMO_PREFIX)) {
      const userId = user.id;

      if (customId.startsWith(MEMO_PREFIX + "prev|")) {
        const currPage = Number(customId.split("|")[1]) || 0;
        const list = await readMemos(userId);
        const page = Math.max(0, currPage - 1);
        const embed = renderMemoListEmbed(userId, list, page, "");
        const rows = renderMemoListButtons(list, page, "");
        return interaction.update({ embeds: [embed], components: rows });
      }
      if (customId.startsWith(MEMO_PREFIX + "next|")) {
        const currPage = Number(customId.split("|")[1]) || 0;
        const list = await readMemos(userId);
        const max = Math.max(0, Math.ceil(list.length / MEMO_PAGE_SIZE) - 1);
        const page = Math.min(max, currPage + 1);
        const embed = renderMemoListEmbed(userId, list, page, "");
        const rows = renderMemoListButtons(list, page, "");
        return interaction.update({ embeds: [embed], components: rows });
      }

      if (customId.startsWith(MEMO_PREFIX + "search|")) {
        const [, encQuery, pageStr] = customId.split("|");
        const modal = new ModalBuilder()
          .setCustomId(MEMO_PREFIX + `search_submit|${pageStr || "0"}`)
          .setTitle("Î©îÎ™® Í≤ÄÏÉâ");
        const ti = new TextInputBuilder()
          .setCustomId("q")
          .setLabel("Ï†úÎ™©/ÎÇ¥Ïö© Í≤ÄÏÉâÏñ¥")
          .setStyle(TextInputStyle.Short)
          .setPlaceholder("Ïòà) ÌöåÏùò, Ìå®Ïä§ÏõåÎìú, TODO")
          .setRequired(true);
        modal.addComponents(new ActionRowBuilder().addComponents(ti));
        return interaction.showModal(modal);
      }

      if (customId.startsWith(MEMO_PREFIX + "add|")) {
        const [, pageStr] = customId.split("|");
        const modal = new ModalBuilder()
          .setCustomId(MEMO_PREFIX + `add_submit|${pageStr || "0"}`)
          .setTitle("ÏÉà Î©îÎ™® Ï∂îÍ∞Ä");
        const tiTitle = new TextInputBuilder()
          .setCustomId("title")
          .setLabel("Ï†úÎ™©")
          .setStyle(TextInputStyle.Short)
          .setPlaceholder("Î©îÎ™® Ï†úÎ™©")
          .setRequired(false);
        const tiBody = new TextInputBuilder()
          .setCustomId("body")
          .setLabel("ÎÇ¥Ïö©")
          .setStyle(TextInputStyle.Paragraph)
          .setPlaceholder("ÏûêÏú† ÏûÖÎ†•")
          .setRequired(false);
        const tiTTL = new TextInputBuilder()
          .setCustomId("ttl")
          .setLabel("Î≥¥Í¥Ä Í∏∞Ìïú(Ïùº) ‚Äî 0/Í≥µÎ∞±=Î¨¥Í∏∞Ìïú")
          .setStyle(TextInputStyle.Short)
          .setRequired(false);
        modal.addComponents(
          new ActionRowBuilder().addComponents(tiTitle),
          new ActionRowBuilder().addComponents(tiBody),
          new ActionRowBuilder().addComponents(tiTTL),
        );
        return interaction.showModal(modal);
      }

      if (customId.startsWith(MEMO_PREFIX + "open|")) {
        const [, id, pageStr] = customId.split("|");
        const list = await readMemos(userId);
        const memo = list.find(m => String(m.id) === String(id));
        if (!memo) {
          return interaction.reply({ content: "Ìï¥Îãπ Î©îÎ™®Î•º Ï∞æÏùÑ Ïàò ÏóÜÏñ¥.", ephemeral: true });
        }
        const embed = renderMemoDetailEmbed(memo);
        const rows = renderMemoDetailButtons(Number(pageStr) || 0);
        return interaction.update({ embeds: [embed], components: rows });
      }

      if (customId.startsWith(MEMO_PREFIX + "back|")) {
        const [, pageStr] = customId.split("|");
        const page = Number(pageStr) || 0;
        const list = await readMemos(userId);
        const embed = renderMemoListEmbed(userId, list, page, "");
        const rows = renderMemoListButtons(list, page, "");
        return interaction.update({ embeds: [embed], components: rows });
      }

      if (customId === MEMO_PREFIX + "del") {
        const embeds = interaction.message.embeds || [];
        if (!embeds.length || !embeds[0].footer?.text) {
          return interaction.reply({ content: "ÏÇ≠Ï†ú ÎåÄÏÉÅÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏñ¥.", ephemeral: true });
        }
        const footer = embeds[0].footer.text;
        const idMatch = footer.match(/ID:\s*(\S+)/);
        const delId = idMatch ? idMatch[1] : null;
        if (!delId) {
          return interaction.reply({ content: "ÏÇ≠Ï†ú ÎåÄÏÉÅÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏñ¥.", ephemeral: true });
        }
        const list = await readMemos(userId);
        const next = list.filter(m => String(m.id) !== String(delId));
        await writeMemos(userId, next);
        const page = 0;
        const embed = renderMemoListEmbed(userId, next, page, "");
        const rows = renderMemoListButtons(next, page, "");
        return interaction.update({ content: "üóë ÏÇ≠Ï†ú ÏôÑÎ£å", embeds: [embed], components: rows });
      }

      if (customId.startsWith(MEMO_PREFIX + "edit|")) {
        const [, pageStr] = customId.split("|");
        const embeds = interaction.message.embeds || [];
        if (!embeds.length || !embeds[0].footer?.text) {
          return interaction.reply({ content: "ÏàòÏ†ï ÎåÄÏÉÅÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏñ¥.", ephemeral: true });
        }
        const footer = embeds[0].footer.text;
        const idMatch = footer.match(/ID:\s*(\S+)/);
        const editId = idMatch ? idMatch[1] : null;
        if (!editId) {
          return interaction.reply({ content: "ÏàòÏ†ï ÎåÄÏÉÅÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏñ¥.", ephemeral: true });
        }

        const list = await readMemos(user.id);
        const memo = list.find(m => String(m.id) === String(editId));
        if (!memo) return interaction.reply({ content: "Ìï¥Îãπ Î©îÎ™®Î•º Ï∞æÏùÑ Ïàò ÏóÜÏñ¥.", ephemeral: true });

        let ttlDays = "";
        if (memo.expiresAt) {
          const leftMs = memo.expiresAt - Date.now();
          if (leftMs > 0) ttlDays = String(Math.ceil(leftMs / (24 * 60 * 60 * 1000)));
        }

        const modal = new ModalBuilder()
          .setCustomId(MEMO_PREFIX + `edit_submit|${memo.id}|${pageStr || "0"}`)
          .setTitle("Î©îÎ™® ÏàòÏ†ï");

        const tiTitle = new TextInputBuilder()
          .setCustomId("title")
          .setLabel("Ï†úÎ™©")
          .setStyle(TextInputStyle.Short)
          .setRequired(false)
          .setValue(memo.title || "");

        const tiBody = new TextInputBuilder()
          .setCustomId("body")
          .setLabel("ÎÇ¥Ïö©")
          .setStyle(TextInputStyle.Paragraph)
          .setRequired(false)
          .setValue(memo.body || "");

        const tiTTL = new TextInputBuilder()
          .setCustomId("ttl")
          .setLabel("Î≥¥Í¥Ä Í∏∞Ìïú(Ïùº) ‚Äî 0/Í≥µÎ∞±=Î¨¥Í∏∞Ìïú")
          .setStyle(TextInputStyle.Short)
          .setRequired(false)
          .setValue(ttlDays);

        modal.addComponents(
          new ActionRowBuilder().addComponents(tiTitle),
          new ActionRowBuilder().addComponents(tiBody),
          new ActionRowBuilder().addComponents(tiTTL),
        );
        return interaction.showModal(modal);
      }
    }

    // ÏàòÏ†ï Ï†úÏ∂ú (Î™®Îã¨)
    if (interaction.isModalSubmit()) {
      const { customId } = interaction;

      if (customId.startsWith(MEMO_PREFIX + "search_submit|")) {
        const [, pageStr] = customId.split("|");
        const q = (interaction.fields.getTextInputValue("q") || "").trim();
        const listAll = await readMemos(interaction.user.id);
        const list = q
          ? listAll.filter(m =>
              (m.title || "").toLowerCase().includes(q.toLowerCase()) ||
              (m.body || "").toLowerCase().includes(q.toLowerCase()))
          : listAll;
        const page = 0;
        const embed = renderMemoListEmbed(interaction.user.id, list, page, q);
        const rows = renderMemoListButtons(list, page, q);
        return interaction.reply({ embeds: [embed], components: rows, ephemeral: true });
      }

      if (customId.startsWith(MEMO_PREFIX + "add_submit|")) {
        const [, pageStr] = customId.split("|");
        const userId = interaction.user.id;
        const title = (interaction.fields.getTextInputValue("title") || "").trim();
        const body = (interaction.fields.getTextInputValue("body") || "").trim();
        const ttlStr = (interaction.fields.getTextInputValue("ttl") || "").trim();
        let expiresAt = null;
        if (ttlStr) {
          const days = Number(ttlStr);
          if (!isNaN(days) && days > 0) {
            expiresAt = Date.now() + days * 24 * 60 * 60 * 1000;
          }
        }
        const list = await readMemos(userId);
        const id = crypto.randomBytes(6).toString("hex");
        const memo = { id, title, body, createdAt: Date.now(), expiresAt };
        list.unshift(memo);
        await writeMemos(userId, list);

        const page = 0;
        const embed = renderMemoListEmbed(userId, list, page, "");
        const rows = renderMemoListButtons(list, page, "");
        return interaction.reply({ content: "‚úÖ Î©îÎ™® Ï∂îÍ∞ÄÎê®", embeds: [embed], components: rows, ephemeral: true });
      }

      if (customId.startsWith(MEMO_PREFIX + "edit_submit|")) {
        const [, id, pageStr] = customId.split("|");
        const userId = interaction.user.id;

        const title = (interaction.fields.getTextInputValue("title") || "").trim();
        const body  = (interaction.fields.getTextInputValue("body")  || "").trim();
        const ttlStr = (interaction.fields.getTextInputValue("ttl")  || "").trim();

        let expiresAt = null;
        if (ttlStr) {
          const days = Number(ttlStr);
          if (!isNaN(days) && days > 0) {
            expiresAt = Date.now() + days * 24 * 60 * 60 * 1000;
          }
        }

        const list = await readMemos(userId);
        const idx = list.findIndex(m => String(m.id) === String(id));
        if (idx === -1) return interaction.reply({ content: "Ìï¥Îãπ Î©îÎ™®Î•º Ï∞æÏùÑ Ïàò ÏóÜÏñ¥.", ephemeral: true });

        list[idx].title = title;
        list[idx].body  = body;
        list[idx].expiresAt = expiresAt;

        await writeMemos(userId, list);

        const updated = list[idx];
        const embed = renderMemoDetailEmbed(updated);
        const rows  = renderMemoDetailButtons(Number(pageStr) || 0);
        return interaction.reply({ content: "‚úÖ ÏàòÏ†ï ÏôÑÎ£å", embeds: [embed], components: rows, ephemeral: true });
      }
    }

    /* ===== Î≥µÍ∂å: Î≤ÑÌäº ===== */
    if (customId === LOTTO_PREFIX + "regen") {
      const userId = user.id;
      const lines = genLottoLines(5, `${userId}:${Date.now()}:${Math.random()}`);
      const embed = renderLottoEmbed(userId, lines);
      const rows = renderLottoButtons();
      return interaction.update({ embeds: [embed], components: rows });
    }

    /* ===== ÏÜåÎùºÍ≥†Îèô ===== */
    if (customId === CONCH_PREFIX + "ask") {
      const modal = new ModalBuilder()
        .setCustomId(CONCH_PREFIX + "ask_submit")
        .setTitle("ÎßàÎ≤ïÏùò ÏÜåÎùºÍ≥†ÎèôÏóêÍ≤å Î¨ºÏñ¥Î≥¥Í∏∞");
      const ti = new TextInputBuilder()
        .setCustomId("q")
        .setLabel("ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Ïòà: Ïò§Îäò ÎÇòÍ∞àÍπå?)")
        .setStyle(TextInputStyle.Short)
        .setRequired(true);
      modal.addComponents(new ActionRowBuilder().addComponents(ti));
      return interaction.showModal(modal);
    }
    if (customId === CONCH_PREFIX + "ask_submit") {
      const q = (interaction.fields.getTextInputValue("q") || "").trim();
      const answer = Math.random() < 0.5 ? "Í∑∏Îûò" : "ÏïÑÎãà";
      const embed = new EmbedBuilder()
        .setTitle("üêö ÎßàÎ≤ïÏùò ÏÜåÎùºÍ≥†Îèô")
        .addFields(
          { name: "ÏßàÎ¨∏", value: q.length ? q : "(ÏßàÎ¨∏ ÏóÜÏùå)" },
          { name: "ÎåÄÎãµ", value: `**${answer}**` },
        )
        .setFooter({ text: "Î¥áÏù¥ Í∑∏Îûò/ÏïÑÎãàÎ°úÎßå ÎãµÌïòÎäî Î™®ÎìúÏïº!" })
        .setColor(0xA66BFF);
      return interaction.reply({ embeds: [embed], ephemeral: true });
    }

    /* ===== Ïù¥ÎØ∏ÏßÄ: Î≤ÑÌäº ===== */
    if (customId.startsWith(IMG_PREFIX)) {
      pruneOldImageSessions();
      let [, action, sessionId] = customId.split("|");
      let sess = imageSessions.get(sessionId);

     // üîÅ ÏÑ∏ÏÖòÏù¥ ÏóÜÏúºÎ©¥ ÏûÑÎ≤†ÎìúÎ°úÎ∂ÄÌÑ∞ Ï¶âÏÑù Î≥µÍµ¨ (Ïû¨ÏãúÏûë/Ìï´Î¶¨Î°úÎìú ÎåÄÏùë)
     if (!sess) {
       try {
         const embed = interaction.message.embeds?.[0];
         const title = embed?.title || "";            // Ïòà: "üñºÔ∏è Ïù¥ÎØ∏ÏßÄ: Í≥†ÏñëÏù¥"
         const imgUrl = embed?.image?.url || null;    // ÌòÑÏû¨ ÌëúÏãú Ï§ëÏù∏ Ïù¥ÎØ∏ÏßÄ URL
         // Ï†úÎ™©ÏóêÏÑú Í≤ÄÏÉâÏñ¥ Ï∂îÏ∂ú
         const m = title.match(/Ïù¥ÎØ∏ÏßÄ:\s*(.+)$/);
         const q = (m && m[1]) ? m[1].trim() : null;
         if (!q) throw new Error("cannot parse query from embed title");
         const lang = detectLang(q);
         let list = await findImages(q, lang);
         if (!Array.isArray(list) || !list.length) {
           return interaction.reply({ content: "Ïù¥ÎØ∏ÏßÄ ÏÜåÏä§Î•º Îã§Ïãú Î∂àÎü¨Ïò§ÏßÄ Î™ªÌñàÏñ¥. Ìïú Î≤àÎßå Îã§Ïãú ÏãúÎèÑÌï¥Ï§ò!", ephemeral: true });
         }
         // ÌòÑÏû¨ ÏûÑÎ≤†ÎìúÏùò Ïù¥ÎØ∏ÏßÄÍ∞Ä Î¶¨Ïä§Ìä∏Ïóê ÏûàÏúºÎ©¥ Í∑∏ Ïù∏Îç±Ïä§Î°ú Î≥µÍµ¨
         let idx = 0;
         if (imgUrl) {
           const found = list.findIndex(u => u === imgUrl);
           if (found >= 0) idx = found;
         }
         const newId = crypto.randomBytes(8).toString("hex");
         sess = { q, lang, list, idx, shared: false, ownerId: interaction.user.id, createdAt: Date.now() };
         imageSessions.set(newId, sess);
         // ÏÑ∏ÏÖòIDÍ∞Ä Î∞îÎÄåÏóàÏúºÎãà, Ïù¥ÌõÑ Î°úÏßÅÏóêÏÑú ÏÇ¨Ïö©Ìï† sessionIdÎ•º ÍµêÏ≤¥
         // (Î≤ÑÌäºÎèÑ ÏÉà ÏÑ∏ÏÖòIDÎ°ú Ïû¨Í∑∏Î¶¨ÎèÑÎ°ù ÏïÑÎûòÏóêÏÑú update Ï≤òÎ¶¨)
         sessionId = newId; // NOTE: const ‚Üí let ÏúºÎ°ú ÏúÑ ÏÑ†Ïñ∏ Î∞îÍø®Îã§Î©¥ Í∞ÄÎä•. ÏïÑÎãàÎ©¥ ÏïÑÎûòÏóêÏÑú Ïû¨ÏÉùÏÑ± Ïãú rowsÏóê newId ÎÑ£Ïñ¥Ï§å.
       } catch (e) {
         return interaction.reply({ content: "ÏÑ∏ÏÖòÏùÑ Î≥µÍµ¨ÌïòÏßÄ Î™ªÌñàÏñ¥. Îã§Ïãú `/Ïú†Ìã∏ Ïù¥ÎØ∏ÏßÄ`Î°ú Í≤ÄÏÉâÌï¥Ï§ò!", ephemeral: true });
       }
     }
      const isOwner = (sess.ownerId === user.id);
      // ÏïàÏ†ÑÏùÑ ÏúÑÌï¥: ÏÑ∏ÏÖò ÏÜåÏú†ÏûêÎßå Ï°∞Ïûë Í∞ÄÎä•(ÏõêÌïòÎ©¥ Ìï¥Ï†ú Í∞ÄÎä•)
      if (!isOwner) {
        return interaction.reply({ content: "Ïù¥ Ïù¥ÎØ∏ÏßÄÎäî Îã§Î•∏ ÏÇ¨Ïö©ÏûêÏùò Í≤ÄÏÉâ ÏÑ∏ÏÖòÏù¥Ïïº.", ephemeral: true });
      }

      if (action === "share") {
        if (sess.shared) {
          return interaction.reply({ content: "Ïù¥ÎØ∏ Ï±ÑÎÑêÏóê Í≥µÏú†Ìïú Ïù¥ÎØ∏ÏßÄÏïº.", ephemeral: true });
        }
        const url = sess.list[sess.idx];
        const embedPub = renderImageEmbed(sess.q, url, sess.lang, true);
        await interaction.channel.send({ embeds: [embedPub] });
        sess.shared = true;
        imageSessions.set(sessionId, sess);

        const embed = renderImageEmbed(sess.q, url, sess.lang, true);
        const rows = renderImageButtons(sessionId, true);
        return interaction.update({ embeds: [embed], components: rows });
      }

      if (action === "more") {
        if (!Array.isArray(sess.list) || !sess.list.length) {
          return interaction.reply({ content: "Í≤∞Í≥ºÍ∞Ä Îçî ÏóÜÏñ¥.", ephemeral: true });
        }
        // Îã§Ïùå ÎûúÎç§ (Í∞ÄÍ∏âÏ†Å Îã§Î•∏ Ïù∏Îç±Ïä§)
        let nextIdx = sess.idx;
        if (sess.list.length > 1) {
          for (let i = 0; i < 5; i++) {
            const cand = Math.floor(Math.random() * sess.list.length);
            if (cand !== sess.idx) { nextIdx = cand; break; }
          }
        }
        sess.idx = nextIdx;
        sess.shared = false; // ÏÉà Ïù¥ÎØ∏ÏßÄÏù¥ÎØÄÎ°ú Îã§Ïãú Í≥µÏú† Í∞ÄÎä•
        imageSessions.set(sessionId, sess);

        const url = sess.list[sess.idx];
        const embed = renderImageEmbed(sess.q, url, sess.lang, false);
        const rows = renderImageButtons(sessionId, false);
        return interaction.update({ embeds: [embed], components: rows });
      }
    }
  },
};
